<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Products Table</title>
  <meta name="csrf-token" content="{{ csrf_token }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
</head>
<body class="p-4 bg-light">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Product List</h1>
    <div>
      <a href="/wishlist/" class="btn btn-outline-danger me-2">‚ù§Ô∏è View Wishlist</a>
      <a href="/cart/" class="btn btn-outline-primary">üõí View Cart</a>
    </div>
  </div>

  <!-- üîç Search Bar -->
  <div class="mb-4 position-relative">
    <input type="text" id="search-bar" class="form-control" placeholder="üîç Search products by name..." autocomplete="off" />
    <ul class="list-group position-absolute w-100 z-3" id="search-results" style="max-height: 200px; overflow-y: auto; display: none;"></ul>
  </div>

  <!-- üì¶ Product Table -->
  <table class="table table-striped table-bordered">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Name</th>
        <th>Price (‚Çπ)</th>
        <th>Discount (%)</th>
        <th>Quantity</th>
      </tr>
    </thead>
    <tbody id="product-body"></tbody>
  </table>

  <!-- üõí Add to Cart -->
  <div class="mb-4">
    <h4>Add to Cart</h4>
    <form id="cart-form" class="row g-2">
      <div class="col-md">
        <input type="number" id="cart-product-id" class="form-control" placeholder="Enter Product ID" required />
      </div>
      <div class="col-md">
        <input type="number" id="cart-quantity" class="form-control" placeholder="Quantity" required />
      </div>
      <div class="col-md-auto">
        <button type="submit" class="btn btn-success">üõí Add to Cart</button>
      </div>
    </form>
  </div>

  <!-- ‚ù§Ô∏è Add to Wishlist -->
  <div class="mb-4">
    <h4>Add to Wishlist</h4>
    <form id="wishlist-form" class="row g-2">
      <div class="col-md">
        <input type="number" id="wishlist-product-id" class="form-control" placeholder="Enter Product ID" required />
      </div>
      <div class="col-md-auto">
        <button type="submit" class="btn btn-danger">‚ù§Ô∏è Add to Wishlist</button>
      </div>
    </form>
  </div>

  <script>
    function getCSRFToken() {
      return document.querySelector('meta[name="csrf-token"]').getAttribute('content');
    }

    // Load products into the table
    function loadProducts() {
      fetch('/api/product/')
        .then(res => res.json())
        .then(data => {
          const tbody = document.getElementById('product-body');
          tbody.innerHTML = '';
          data.forEach(product => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${product.id}</td>
              <td>${product.name}</td>
              <td>‚Çπ${product.price}</td>
              <td>${product.discount}%</td>
              <td>${product.quantity ?? '-'}</td>
            `;
            tbody.appendChild(row);
          });
        });
    }

    // üõí Add to Cart
    document.getElementById('cart-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const productId = document.getElementById('cart-product-id').value;
      const quantity = document.getElementById('cart-quantity').value;

      fetch('/api/cart/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ product_id: productId, quantity })
      })
      .then(res => {
        if (!res.ok) throw res;
        alert("‚úÖ Added to cart!");
      })
      .catch(async err => {
        const errData = await err.json();
        alert("‚ùå " + (errData.detail || "Failed to add to cart"));
      });
    });

    // ‚ù§Ô∏è Add to Wishlist
    document.getElementById('wishlist-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const productId = document.getElementById('wishlist-product-id').value;

      fetch('/api/wishlist/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCSRFToken()
        },
        body: JSON.stringify({ product_id: productId })
      })
      .then(res => {
        if (!res.ok) throw res;
        alert("‚úÖ Added to wishlist!");
      })
      .catch(async err => {
        const errData = await err.json();
        alert("‚ùå " + (errData.detail || "Failed to add to wishlist"));
      });
    });

    // üîç Search functionality
    const searchInput = document.getElementById('search-bar');
    const resultsBox = document.getElementById('search-results');

    searchInput.addEventListener('input', function () {
      const query = this.value.trim();
      if (!query) {
        resultsBox.style.display = 'none';
        resultsBox.innerHTML = '';
        return;
      }

      fetch(`/api/product/?search=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
          resultsBox.innerHTML = '';
          if (data.length === 0) {
            resultsBox.style.display = 'none';
            return;
          }

          data.forEach(product => {
            const item = document.createElement('li');
            item.className = 'list-group-item list-group-item-action';
            item.innerHTML = `<strong>${product.name}</strong> ‚Äì ‚Çπ${product.price}`;
            item.addEventListener('click', () => {
              searchInput.value = product.name;
              resultsBox.innerHTML = '';
              resultsBox.style.display = 'none';
            });
            resultsBox.appendChild(item);
          });

          resultsBox.style.display = 'block';
        })
        .catch(() => {
          resultsBox.innerHTML = '<li class="list-group-item text-danger">Error fetching results</li>';
          resultsBox.style.display = 'block';
        });
    });

    // Hide dropdown on outside click
    document.addEventListener('click', function (e) {
      if (!searchInput.contains(e.target) && !resultsBox.contains(e.target)) {
        resultsBox.style.display = 'none';
      }
    });

    // Initial load
    loadProducts();
  </script>
</body>
</html>
